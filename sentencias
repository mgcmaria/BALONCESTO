CREATE TABLE EQUIPOS (
ID_EQUIPO INT PRIMARY KEY,
NOMBRE VARCHAR(30) NOT NULL,
CIUDAD VARCHAR (20),
WEB_OFICIAL VARCHAR(60),
PUNTOS INT);
CREATE SEQUENCE ID_EQUIPO START WITH 1;


CREATE TABLE JUGADORES (
ID_JUGADOR INT PRIMARY KEY,
APELLIDO VARCHAR(30) NOT NULL,
NOMBRE VARCHAR (20),
ID_CAPITAN INT,
PUESTO VARCHAR(10),
FECHA_ALTA DATE,
SALARIO_BRUTO NUMBER(8,2),
EQUIPO INT REFERENCES EQUIPOS(ID_EQUIPO),
ALTURA NUMBER(3,2)
);
CREATE SEQUENCE ID_JUGADOR START WITH 1;

CREATE TABLE PARTIDOS (
NUM_PARTIDO INT PRIMARY KEY,
E_LOCAL INT NOT NULL REFERENCES EQUIPOS(ID_EQUIPO),
E_VISITANTE INT NOT NULL REFERENCES EQUIPOS(ID_EQUIPO),
RESULTADO VARCHAR (10),
FECHA DATE,
ARBITRO NUMBER(2) CHECK (ARBITRO IS NULL OR (ARBITRO>=1 AND ARBITRO <=15))
);
CREATE SEQUENCE NUM_PARTIDO START WITH 1;


INSERT INTO EQUIPOS VALUES (ID_EQUIPO.NEXTVAL,'REGAL BARCELONA','BARCELONA','HTTP://WWW.FCBARCELONA.COM',10);
INSERT INTO EQUIPOS VALUES (ID_EQUIPO.NEXTVAL,'REAL MADRID','MADRID','HTTP://WWW.REALMADRID.COM',9);
INSERT INTO EQUIPOS VALUES (ID_EQUIPO.NEXTVAL,'P.E. VALENCIA','VALENCIA','HTTP://WWW.VALENCIABASKET.COM',11);
INSERT INTO EQUIPOS VALUES (ID_EQUIPO.NEXTVAL,'CAJA LABORAL','VITORIA','HTTP://WWW.BASKONIA.COM',22);
INSERT INTO EQUIPOS VALUES (ID_EQUIPO.NEXTVAL,'GRAN CANARIA','LAS PALMAS','HTTP://WWW.ACB.COM/CLUB.PHP?ID=CLA',14);
INSERT INTO EQUIPOS VALUES (ID_EQUIPO.NEXTVAL,'CAI ZARAGOZA','ZARAGOZA','HTTP://WWW.BASKETZARAGOZA.NET',23);


INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'NAVARRO','JUAN CARLOS',1,'ESCOLTA','10/01/10',130000,1,2.02);
INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'REYES','FELIPE',2,'PIVOT','20/02/09',120000,2,2.04);
INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'CALVER','VICTOR',3,'ALERO','08/03/09',90000,3,2.08);
INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'MARTINEZ','RAFA',4,'ESCOLTA','11/11/10',51000,3,1.91);
INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'SAN EMETERIO','FERNANDO',6,'ALERO','22/09/08',60000,4,1.99);
INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'TELETOVIC','MIRZA',6,'PIVOT','13/05/10',70000,4,2.06);
INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'LLUL','SERGIO',2,'ESCOLTA','29/10/11',80000,1,1.92);
INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'SADA','VICTOR',1,'BASE','01/01/12',80000,1,1.92);
INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'SUAREZ', 'CARLOS',2,'ALERO','19/02/11',60000,2,2.03);
INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'REY','XAVI',14,'PIVOT','12/10/08',95000,5,2.09);
INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'CABEZAS','CARLOS',13,'BASE','21/01/12,105000,6,1.86);
INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'AGUILAR','PABLO',13,'ALERO','14/06/11',47000,6,2.03);
INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'HETTSHEIMEIR','RAFA',13,'PIVOT','15/04/08',53000,6,2.08);
INSERT INTO JUGADORES VALUES (ID_JUGADOR.NEXTVAL, 'SAVANE','SITAPHA',14,'PIVOT','27/07/11',60000,5,2.01);

-- Obtener los datos de todos los equipos

select * from equipos;

--2

SELECT nombre||' '||apellido as "NOMBRE JUGADOR"
FROM JUGADORES;

--3 

SELECT nombre||' '||apellido as "NOMBRE JUGADOR", PUESTO
FROM JUGADORES
ORDER BY PUESTO,NOMBRE;

--4 

SELECT NOMBRE, EQUIPO, PUESTO
FROM JUGADORES
ORDER BY EQUIPO, PUESTO;

--5

SELECT APELLIDO||', '||SUBSTR(NOMBRE,1,1)||'.' AS JUGADOR, EQUIPO, PUESTO
FROM JUGADORES
ORDER BY EQUIPO, PUESTO DESC;

--6

SELECT DISTINCT EQUIPO
FROM JUGADORES;

--7

SELECT NOMBRE, APELLIDO, SALARIO_BRUTO*0.82||' €' AS "SALARIO NETO ANUAL"
FROM JUGADORES;

--8

SELECT NOMBRE, APELLIDO
FROM JUGADORES
WHERE PUESTO='PIVOT';

--9

SELECT *
FROM JUGADORES
WHERE EQUIPO<>7;

--10

SELECT *
FROM EQUIPOS
WHERE CIUDAD NOT IN ('VALENCIA', 'MADRID');

--11

SELECT NUM_PARTIDO, E_LOCAL, E_VISITANTE, RESULTADO, TO_CHAR(FECHA,'DD')||' de '||to_char(FECHA,'MONTH')
    ||' de '||to_char(FECHA,'YYYY') as fecha, arbitro
    from partidos
    where fecha between '01/11/17' and '30/11/17';
    
--12

select *
from equipos
where nombre like 'C%';

--13

select *
from equipos
where nombre <='K'
order by nombre;

--14

select *
from jugadores
where nombre like '____';

--15

select *
from jugadores
where nombre like 'F%' or nombre like 'P%';

--16

select nombre, salario_bruto
from jugadores
where (salario_bruto>100000) AND (puesto='PIVOT');

--17

SELECT NOMBRE||' '||APELLIDO AS JUGADOR
FROM JUGADORES
WHERE PUESTO='BASE' AND (EQUIPO=7 OR EQUIPO=8);

--18

SELECT *
FROM JUGADORES
WHERE EQUIPO=9
ORDER BY APELLIDO;

--19

SELECT *
FROM JUGADORES
WHERE PUESTO='PIVOT'
ORDER BY ID_JUGADOR;

--20

SELECT *
FROM JUGADORES
WHERE ALTURA>2 AND SALARIO_BRUTO<60000;

--21

SELECT *
FROM PARTIDOS
WHERE FECHA LIKE '%/02/%';

--47

SELECT
    j.apellido || ', '|| j.nombre AS jugador, puesto
FROM
    jugadores j
    JOIN equipos e ON e.id_equipo = j.equipo
    JOIN partidos p ON p.e_local = id_equipo
WHERE
    p.e_visitante = ( SELECT id_equipo FROM equipos WHERE  nombre LIKE '%VALENCIA%');
    
-- 27: Encontrar el salario más alto, el más bajo y la diferencia entre ambos

SELECT MAX(SALARIO_BRUTO), MIN(SALARIO_BRUTO), (MAX(SALARIO_BRUTO)-MIN(SALARIO_BRUTO)) AS Diferencia
FROM JUGADORES;

-- 28> Hallar el número de ciudades en las que hay equipos registrados

SELECT DISTINCT COUNT(CIUDAD) AS "NÚMERO DE CIUDADES"
FROM EQUIPOS;

-- 29> Obtener la cantidad total que se paga a los jugadores al mes suponiendo un IRPF del 18%.

SELECT ROUND (SUM((SALARIO_BRUTO*0.82)/12)) AS "SALARIO MENSUAL"
FROM JUGADORES;

--30> -Seleccionar el número de jugadores por equipo

SELECT E.NOMBRE AS "NOMBRE EQUIPO", COUNT(*) AS "NUMERO DE JUGADORES"
FROM EQUIPOS E, JUGADORES J
WHERE E.ID_EQUIPO=J.EQUIPO
GROUP BY E.NOMBRE;

--31> Seleccionar por cada equipo el salario mínimo y máximo de los jugadores

SELECT ID_EQUIPO AS EQUIPO, MIN(SALARIO_BRUTO) AS "SALARIO MÍNIMO", MAX(SALARIO_BRUTO) AS "SALARIO MÁXIMO"
FROM EQUIPOS E, JUGADORES J
WHERE E.ID_EQUIPO=J.EQUIPO
GROUP BY E.ID_EQUIPO
ORDER BY E.ID_EQUIPO;

-- 32> Seleccionar el salario medio de cada equipo, pero solo para aquellos que esa media supere los 70.000 euros

SELECT EQUIPO, TO_CHAR(AVG(SALARIO_BRUTO),'999G999')||' €' AS "SALARIO MEDIO"
FROM JUGADORES 
GROUP BY EQUIPO
HAVING AVG(SALARIO_BRUTO)>70000
ORDER BY 1;

--33> ¿Cuántos partidos se jugaron en febrero?

SELECT COUNT(*) AS "PARTIDOS EN FEBRERO"
FROM PARTIDOS
WHERE FECHA LIKE '%/02/%';

34> Obtener el identificador de equipo y la suma de las alturas de sus jugadores.

SELECT EQUIPO, SUM(ALTURA) AS "SUMA DE LAS ALTURAS"
FROM JUGADORES
GROUP BY EQUIPO
ORDER BY EQUIPO;

35> Obtener el identificador de equipo y el salario total de cada equipo para equipos con más de 2 jugadores registrados.

SELECT EQUIPO, TO_CHAR(SUM(SALARIO_BRUTO), '999G999')||'€' AS "SALARIO TOTAL"
FROM JUGADORES
GROUP BY EQUIPO
HAVING COUNT(*)>2
ORDER BY 1;

--36> Obtener el nombre del jugador más alto.

SELECT NOMBRE||' '||APELLIDO AS "JUGADOR MAS ALTO", ALTURA
FROM JUGADORES
WHERE ALTURA=(SELECT MAX(ALTURA) FROM JUGADORES);

37> Obtener los datos de los jugadores cuyos salarios sean mayores que el de Sergio Llul.

SELECT *
FROM JUGADORES
WHERE SALARIO_BRUTO>(SELECT SALARIO_BRUTO FROM JUGADORES WHERE APELLIDO='LLUL');

--38> Calcular el número de jugadores por equipo que cobra más que el salario medio de todos los jugadores.

SELECT EQUIPO, COUNT(*) AS "NUMERO DE JUGADORES"
FROM JUGADORES
WHERE SALARIO_BRUTO> (SELECT AVG(SALARIO_BRUTO) FROM JUGADORES)
GROUP BY EQUIPO
ORDER BY 1;

--39> Obtener el nombre de los jugadores que ganen más que todos los del equipo 2

SELECT NOMBRE||' '||APELLIDO AS JUGADOR
FROM JUGADORES
WHERE SALARIO_BRUTO>ALL(SELECT SALARIO_BRUTO FROM JUGADORES WHERE EQUIPO=8);

--40> Seleccionar los jugadores que ganen más que alguno de los del equipo 1 y no sea de ese
equipo.

SELECT EQUIPO, NOMBRE, APELLIDO
FROM JUGADORES
WHERE SALARIO_BRUTO> ANY(SELECT SALARIO_BRUTO FROM JUGADORES WHERE EQUIPO=7)
AND EQUIPO<>7
ORDER BY 1;

--41> Obtener los datos de los jugadores que jueguen en Zaragoza:

SELECT *
FROM JUGADORES J
JOIN EQUIPOS E
ON J.EQUIPO=E.ID_EQUIPO
WHERE CIUDAD='ZARAGOZA';

--42> Obtener los datos de los jugadores pero solo si hay más de 10 equipos.(salida vacía).

SELECT *
FROM JUGADORES J1
WHERE ALTURA>(SELECT AVG(ALTURA) FROM JUGADORES J2 WHERE J1.EQUIPO=J2.EQUIPO);

--44> Obtener los datos de los equipos con al menos 3 jugadores

SELECT *
FROM EQUIPOS E
WHERE (SELECT COUNT(*) FROM JUGADORES J WHERE J.EQUIPO=E.ID_EQUIPO)>=3;

SELECT *
FROM EQUIPOS E
JOIN JUGADORES J
ON E.ID_EQUIPO=J.EQUIPO
HAVING COUNT(*)>=3;

--45> Obtener los datos de los jugadores con el salario medio de su equipo y la diferencia de éste con el de cada jugador.

SELECT J1.NOMBRE||' '||J1.APELLIDO AS JUGADOR, 
        TO_CHAR(J1.SALARIO_BRUTO, '999G999D99')||' €' AS "SALARIO BRUTO",
        TO_CHAR(AVG(J1.SALARIO_BRUTO),'999G999D99')||' €' AS "SALARIO MEDIO DE SU EQUIPO",
        TO_CHAR((J1.SALARIO_BRUTO-AVG(J1.SALARIO_BRUTO)),'999G999D99')||'€' AS DIFERENCIA
FROM JUGADORES J1
JOIN JUGADORES J2
ON J1.EQUIPO=J2.EQUIPO
GROUP BY J1.NOMBRE,J1.APELLIDO, J1.SALARIO_BRUTO;

--46> Suma de alturas de los jugadores del CAI y del Madrid.

SELECT SUM(ALTURA) AS "SUMA DE LAS ALTURAS"
FROM JUGADORES J
JOIN EQUIPOS E
ON J.EQUIPO=E.ID_EQUIPO
WHERE E.NOMBRE LIKE '%MADRID' OR E.NOMBRE LIKE 'CAI%';

SELECT SUM(ALTURA)
FROM JUGADORES 
WHERE EQUIPO=8 OR EQUIPO=12;

--47> Obtener los datos de los jugadores que hayan jugado algún partido contra el Valencia en casa.

SELECT J.APELLIDO||', '||J.NOMBRE AS "JUGADOR", PUESTO
FROM JUGADORES J
JOIN PARTIDOS P
ON J.EQUIPO=P.E_LOCAL
WHERE P.E_VISITANTE=(SELECT ID_EQUIPO FROM EQUIPOS WHERE NOMBRE LIKE '%VALENCIA%');

--48> Nombre de los jugadores que midan más que todos los del Caja Laboral.

SELECT NOMBRE||' '||APELLIDO
FROM JUGADORES 
WHERE ALTURA>ALL    (SELECT ALTURA 
                    FROM JUGADORES, EQUIPOS
                    WHERE EQUIPO=ID_EQUIPO AND EQUIPOS.NOMBRE LIKE '%LABORAL%');

--49> Datos de jugadores cuyo salario sea mayor que el de sus capitanes.

SELECT *
FROM JUGADORES A    
WHERE A.SALARIO_BRUTO> (SELECT SALARIO_BRUTO FROM JUGADORES B WHERE A.ID_CAPITAN=B.ID_JUGADOR);

--50> Nombre del equipo con más jugadores registrados.

SELECT E.NOMBRE AS "NOMBRE EQUIPO"
FROM EQUIPOS E
JOIN JUGADORES J
ON J.EQUIPO=E.ID_EQUIPO
GROUP BY E.NOMBRE
HAVING COUNT(*) >= ALL (SELECT COUNT(*) FROM JUGADORES);

SELECT NOMBRE
FROM EQUIPOS
WHERE ID_EQUIPO IN (SELECT EQUIPO FROM JUGADORES GROUP BY EQUIPO HAVING COUNT(*) >= ALL
(SELECT COUNT(EQUIPO)FROM JUGADORES GROUP BY EQUIPO));

-- 51> Nombre de los jugadores mejor y peor pagados.

SELECT NOMBRE||' '||APELLIDO AS JUGADOR, SALARIO_BRUTO AS SALARIO
FROM JUGADORES
WHERE SALARIO_BRUTO = (SELECT MAX(SALARIO_BRUTO) FROM JUGADORES) 
OR SALARIO_BRUTO=(SELECT MIN(SALARIO_BRUTO) FROM JUGADORES);

--52> Obtener el número de jugadores de equipos de Madrid

SELECT COUNT (*) AS "JUGADORES DE MADRID"
FROM JUGADORES J
JOIN EQUIPOS E
ON J.EQUIPO=E.ID_EQUIPO
WHERE E.CIUDAD='MADRID';

--53> Nombre de jugador, nombre de equipo y puesto del mismo

SELECT J.NOMBRE||' '||APELLIDO AS JUGADOR, E.NOMBRE AS "NOMBRE EQUIPO", PUESTO
FROM JUGADORES J, EQUIPOS E
WHERE J.EQUIPO=E.ID_EQUIPO;

-- 54> Nombre de los equipos y número de partidos que han jugado como locales.

SELECT NOMBRE, COUNT(*) AS "PARTIDOS COMO LOCALES"
FROM EQUIPOS E, PARTIDOS P
WHERE ID_EQUIPO=E_LOCAL
GROUP BY NOMBRE
ORDER BY 1;

--55> Datos de equipos y salario máximo entre sus jugadores

SELECT ID_EQUIPO, E.NOMBRE, CIUDAD, WEB_OFICIAL, PUNTOS, MAX(J.SALARIO_BRUTO) AS "SALARIO MAXIMO"
FROM EQUIPOS E, JUGADORES J
WHERE E.ID_EQUIPO=J.EQUIPO
GROUP BY ID_EQUIPO,E.NOMBRE, CIUDAD, WEB_OFICIAL, PUNTOS;

--56> Cambia el capitán de Rafa Martínez (jugador 4) que es ahora Victor Claver (jugador 3)

UPDATE JUGADORES
SET ID_CAPITAN=3
WHERE ID_JUGADOR=36;

--57> Obtener el nombre de los equipos junto al de su capitán

SELECT E.NOMBRE AS "NOMBRE EQUIPO", J.NOMBRE||' '||APELLIDO AS CAPITAN
FROM EQUIPOS E, JUGADORES J
WHERE E.ID_EQUIPO=J.ID_CAPITAN;

SELECT E.NOMBRE, E1.NOMBRE||' '||E1.APELLIDO AS CAPITAN
FROM JUGADORES E1 , EQUIPOS
WHERE E1.EQUIPO=ID_EQUIPO
AND E1.ID_JUGADOR = (SELECT E2.ID_JUGADOR
FROM JUGADORES E2
WHERE E2.ID_JUGADOR = E1.ID_CAPITAN)
ORDER BY 1;


